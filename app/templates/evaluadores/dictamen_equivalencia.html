{% extends "base.html" %}
{% block title %}Dictamen de Equivalencia - Sistema de Equivalencias CRUB{% endblock %}

{% block header %}Emitir Dictamen de Equivalencia{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-gavel"></i> Dictamen para Solicitud #{{ solicitud.id_solicitud }}</h5>
        <span class="badge {% if solicitud.estado == 'pendiente' %}bg-warning text-dark{% elif solicitud.estado == 'en_evaluacion' %}bg-info{% elif solicitud.estado == 'aprobada' %}bg-success{% elif solicitud.estado == 'rechazada' %}bg-danger{% endif %}">
            {{ solicitud.estado|title }}
        </span>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <div class="row">
                <div class="col-md-6">
                    <h6>Solicitante: {{ solicitud.nombre_solicitante }} {{ solicitud.apellido_solicitante }}</h6>
                </div>
                <div class="col-md-6 text-md-end">
                    <h6>{{ solicitud.institucion_origen }} → {{ solicitud.carrera_crub_destino }}</h6>
                </div>
            </div>
        </div>
        
        {% if solicitud.ruta_archivo %}
        <div class="mb-4">
            <a href="{{ url_for('static', filename=solicitud.ruta_archivo) }}" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-file-pdf"></i> Ver Documentación
            </a>
            <a href="{{ url_for('evaluadores.view_equivalencia', id=solicitud.id) }}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-info-circle"></i> Ver Detalles Completos
            </a>
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('evaluadores.dictamen_equivalencia', id=solicitud.id) }}">
            <div class="card mb-4 bg-light">
                <div class="card-header">
                    <h6 class="mb-0">Estado Final de la Solicitud</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="estado_solicitud" class="form-label">Estado de la Solicitud</label>
                                <select class="form-select" id="estado_solicitud" name="estado_solicitud">
                                    <option value="en_evaluacion" {% if solicitud.estado == 'en_evaluacion' %}selected{% endif %}>En Evaluación</option>
                                    <option value="aprobada" {% if solicitud.estado == 'aprobada' %}selected{% endif %}>Aprobada</option>
                                    <option value="rechazada" {% if solicitud.estado == 'rechazada' %}selected{% endif %}>Rechazada</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="my-3 py-2">
                                <button type="submit" name="rechazar_solicitud" class="btn btn-danger" onclick="return confirm('¿Está seguro que desea rechazar completamente esta solicitud de equivalencia?')">
                                    <i class="fas fa-times-circle"></i> Rechazar Solicitud Completa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mb-3">Dictamen por Asignatura</h5>
            
            {% for dictamen in solicitud.dictamenes %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Dictamen #{{ loop.index }}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dictamen_{{ dictamen.id }}_asignatura_origen" class="form-label">Asignatura de Origen</label>
                                <input type="text" class="form-control" id="dictamen_{{ dictamen.id }}_asignatura_origen" name="dictamen_{{ dictamen.id }}_asignatura_origen" value="{{ dictamen.asignatura_origen }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dictamen_{{ dictamen.id }}_asignatura_destino" class="form-label">Asignatura de Destino</label>
                                <input type="text" class="form-control" id="dictamen_{{ dictamen.id }}_asignatura_destino" name="dictamen_{{ dictamen.id }}_asignatura_destino" value="{{ dictamen.asignatura_destino }}" {% if dictamen.tipo_equivalencia == 'sin_equivalencia' %}disabled{% endif %}>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dictamen_{{ dictamen.id }}_tipo_equivalencia" class="form-label">Tipo de Equivalencia</label>
                                <select class="form-select tipo-equivalencia" id="dictamen_{{ dictamen.id }}_tipo_equivalencia" name="dictamen_{{ dictamen.id }}_tipo_equivalencia" data-id="{{ dictamen.id }}">
                                    <option value="pendiente" {% if not dictamen.tipo_equivalencia %}selected{% endif %}>Sin Evaluar</option>
                                    <option value="total" {% if dictamen.tipo_equivalencia == 'total' %}selected{% endif %}>Total</option>
                                    <option value="parcial" {% if dictamen.tipo_equivalencia == 'parcial' %}selected{% endif %}>Parcial</option>
                                    <option value="sin_equivalencia" {% if dictamen.tipo_equivalencia == 'sin_equivalencia' %}selected{% endif %}>Sin Equivalencia</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dictamen_{{ dictamen.id }}_observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="dictamen_{{ dictamen.id }}_observaciones" name="dictamen_{{ dictamen.id }}_observaciones" rows="2">{{ dictamen.observaciones }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <a href="{{ url_for('evaluadores.eliminar_dictamen', id=dictamen.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Está seguro que desea eliminar este dictamen?')">
                        <i class="fas fa-trash"></i> Eliminar
                    </a>
                </div>
            </div>
            {% endfor %}
                  <!-- Formulario separado para agregar asignatura que no interfiera con el formulario principal -->
        <form method="POST" action="{{ url_for('evaluadores.agregar_dictamen', solicitud_id=solicitud.id) }}" class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Agregar Nueva Asignatura</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="mb-3">
                                <label for="asignatura_origen" class="form-label">Asignatura de Origen</label>
                                <input type="text" class="form-control" id="asignatura_origen" name="asignatura_origen">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-3">
                                <label for="asignatura_destino" class="form-label">Asignatura de Destino</label>
                                <input type="text" class="form-control" id="asignatura_destino" name="asignatura_destino">
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <div class="mb-3 w-100">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        </form>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="{{ url_for('evaluadores.list_equivalencias') }}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Dictamen</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar cambios en el tipo de equivalencia
        const tipoEquivalenciaSelects = document.querySelectorAll('.tipo-equivalencia');
        
        tipoEquivalenciaSelects.forEach(function(select) {
            const dictamenId = select.dataset.id;
            
            select.addEventListener('change', function() {
                const asignaturaDestinoInput = document.getElementById(`dictamen_${dictamenId}_asignatura_destino`);
                
                if (this.value === 'sin_equivalencia') {
                    asignaturaDestinoInput.disabled = true;
                    asignaturaDestinoInput.value = '';
                } else {
                    asignaturaDestinoInput.disabled = false;
                }
            });
        });
    });
</script>
{% endblock %}
